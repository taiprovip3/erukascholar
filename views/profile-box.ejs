<!-- The Modal -->
<% if(payload.userData) { %>
<style>
  #profileBox .modal-body {
    background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRn6K94GJRJhQSBE9QYCuZLuMTNi7fL8EllzSE1I3CVvC86mJLQDWUzgjGvWv9CalGIYqA&usqp=CAU');
    box-shadow:
      rgb(85, 91, 255) 0px 0px 0px 3px,
      rgb(31, 193, 27) 0px 0px 0px 6px,
      rgb(255, 217, 19) 0px 0px 0px 9px,
      rgb(255, 156, 85) 0px 0px 0px 12px,
      rgb(255, 85, 85) 0px 0px 0px 15px;
  }
</style>
<div class="modal fade" id="profileBox">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <!-- Modal body -->
      <div class="modal-body">
        <div class="text-end">
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="container">
          <div class="row d-flex justify-content-center" id="info-row">
            <div
              class="col-2 pt-2 border-end border-dark"
              style="
                background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRV3MnyeO5LAIsaQk_Dxc0dNb-FZQrE4CuU3lhZA9xaG94hQ5mhT_4pb8YFbQWpOoIZxD4&usqp=CAU');
              "
            >
              <ul class="nav nav-tabs flex-column">
                <li class="nav-item">
                  <a class="nav-link fw-bolder active" href="javascript:void(0);">Th√¥ng tin</a>
                </li>
                <li class="nav-item">
                  <a
                    class="nav-link fw-bolder borrow"
                    href="javascript:void(0);"
                    id="transfer-coin-li"
                    onclick="changeRowDisplay(this);"
                    >Chuy·ªÉn xu v√†o Server</a
                  >
                </li>
                <li class="nav-item">
                  <a
                    class="nav-link fw-bolder borrow"
                    href="javascript:void(0);"
                    id="history-li"
                    onclick="changeRowDisplay(this);"
                    >L·ªãch s·ª≠ giao d·ªãch</a
                  >
                </li>
              </ul>
            </div>
            <div
              class="col-4 pt-2 small position-relative"
              style="
                background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSVtergqy1I5RFXcG1--88_88HYHcS07MJhQf3awPzIq5uMYnmnCAFNssPlDhrAVdEBuSI&usqp=CAU');
              "
            >
              <div class="mb-3 text-center">
                <div class="position-relative">
                  <img src="<%= payload.userData.avatar %>" alt="avatar" width="100px" />
                  <div class="position-absolute end-0 bottom-0 crs violet rounded-1" onclick="uploadAvatar();">
                    <i class="fa-regular fa-images"></i>
                  </div>
                </div>
                <h5><%= payload.userData.username %></h5>
                <span class="d-block"
                  >ƒê√£ tham gia:
                  <span class="borrow fw-bold"><%= helper.calculateTimeAgo(payload.userData.createdAt) %></span></span
                >
                <!-- <div class="d-flex align-items-center">
                                <div class="progress flex-fill">
                                    <div class="progress-bar bg-success" style="width:99%"></div>
                                    99üåø
                                </div>
                                <div class="small">100üåø</div>
                            </div> -->
                <span
                  >Th√†nh vi√™n th·ª© <span class="text-primary">#<%= payload.userData.profileId %></span></span
                >
                <br />
                <br />
                <div class="form-check form-switch">
                  <% if(payload.userData.isVerified) { %>
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="mySwitch"
                    name="darkmode"
                    value="yes"
                    checked
                    onchange="this.checked = !this.checked"
                  />
                  ‚úÖ
                  <% } else { %>
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="mySwitch"
                    name="darkmode"
                    value="no"
                    onclick="letVerifyAccount();"
                  />
                  ‚≠ï
                  <% } %>
                  <label class="form-check-label" for="mySwitch">X√°c th·ª±c T√†i kho·∫£n</label>
                </div>
              </div>
              <div class="position-absolute bottom-0 w-100 text-center mb-3">
                <a class="btn btn-danger" type="button" href="/logout">ƒêƒÉng xu·∫•t</a>
              </div>
            </div>
            <div
              class="col-6 pt-2 small"
              style="
                background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSVtergqy1I5RFXcG1--88_88HYHcS07MJhQf3awPzIq5uMYnmnCAFNssPlDhrAVdEBuSI&usqp=CAU');
              "
            >
              <h5 class="borrow fw-bold">Th√¥ng tin</h5>
              <div class="d-flex flex-wrap justify-content-between">
                <div>
                  <div class="mb-3 mt-3">
                    <label for="fullname" class="form-label">H·ªç v√† t√™n</label>
                    <input
                      type="text"
                      class="form-control text-white"
                      id="fullname"
                      placeholder="Enter fullname"
                      value="<%=  payload.userData.fullname %>"
                      name="fullname"
                      style="background-color: #1a233a"
                    />
                  </div>
                </div>
                <div>
                  <div class="mb-3 mt-3">
                    <label for="email" class="form-label">Email</label>
                    <% if(payload.userData.isVerified) { %>
                    <input
                      type="email"
                      class="form-control text-white"
                      id="email"
                      placeholder="Enter email"
                      value="<%=  payload.userData.email %>"
                      name="email"
                      style="background-color: #1a233a"
                      readonly
                    />
                    <% } else { %>
                    <input
                      type="email"
                      class="form-control text-white"
                      id="email"
                      placeholder="Enter email"
                      value="<%=  payload.userData.email %>"
                      name="email"
                      style="background-color: #1a233a"
                    />
                    <% } %>
                  </div>
                </div>
                <div>
                  <div class="mb-3 mt-3">
                    <label for="sdt" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                    <select name="country" id="country">
                      <option value="+84">+84</option>
                    </select>
                    <input
                      type="text"
                      class="form-control text-white"
                      id="sdt"
                      placeholder="Enter sdt"
                      value="<%=  payload.userData.sdt %>"
                      name="sdt"
                      style="background-color: #1a233a"
                    />
                  </div>
                </div>
              </div>
              <h5 class="borrow fw-bold">ƒê·ªãa ch·ªâ</h5>
              <textarea
                class="form-control text-white"
                rows="5"
                id="address"
                name="address"
                style="background-color: #1a233a"
              >
<!=  payload.userData.address !></textarea
              >
              <div class="w-100 mt-3 mb-3 text-end">
                <button class="btn btn-primary w-25" onclick="saveProfile();">C·∫≠p nh·∫≠t</button>
              </div>
            </div>
          </div>
          <div class="d-none justify-content-center" id="transfer-coin-row">
            <div
              class="col-2 pt-2 border-end border-dark"
              style="
                background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRV3MnyeO5LAIsaQk_Dxc0dNb-FZQrE4CuU3lhZA9xaG94hQ5mhT_4pb8YFbQWpOoIZxD4&usqp=CAU');
              "
            >
              <ul class="nav nav-tabs flex-column">
                <li class="nav-item">
                  <a
                    class="nav-link fw-bolder borrow"
                    href="javascript:void(0);"
                    id="info-li"
                    onclick="changeRowDisplay(this);"
                    >Th√¥ng tin</a
                  >
                </li>
                <li class="nav-item">
                  <a class="nav-link fw-bolder active" href="javascript:void(0);">Chuy·ªÉn xu v√†o Server</a>
                </li>
                <li class="nav-item">
                  <a
                    class="nav-link fw-bolder borrow"
                    href="javascript:void(0);"
                    id="history-li"
                    onclick="changeRowDisplay(this);"
                    >L·ªãch s·ª≠ giao d·ªãch</a
                  >
                </li>
              </ul>
            </div>
            <div
              class="col-10 pt-2 small position-relative"
              style="
                background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSVtergqy1I5RFXcG1--88_88HYHcS07MJhQf3awPzIq5uMYnmnCAFNssPlDhrAVdEBuSI&usqp=CAU');
              "
            >
              <div>S·ªë xu ƒëang c√≥: 0 ü•Æ</div>
              <div>
                <span>Chuy·ªÉn v√†o server:</span>
                <select name="" id="">
                  <option value="">Vui l√≤ng ch·ªçn server chuy·ªÉn v√†o</option>
                  <option value="">Skyblock</option>
                  <option value="">Prison</option>
                  <option value="">Towny</option>
                </select>
              </div>
            </div>
          </div>
          <div class="d-none justify-content-center" id="history-row">
            <div
              class="col-2 pt-2 border-end border-dark"
              style="
                background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRV3MnyeO5LAIsaQk_Dxc0dNb-FZQrE4CuU3lhZA9xaG94hQ5mhT_4pb8YFbQWpOoIZxD4&usqp=CAU');
              "
            >
              <ul class="nav nav-tabs flex-column">
                <li class="nav-item">
                  <a
                    class="nav-link fw-bolder borrow"
                    href="javascript:void(0);"
                    id="info-li"
                    onclick="changeRowDisplay(this);"
                    >Th√¥ng tin</a
                  >
                </li>
                <li class="nav-item">
                  <a
                    class="nav-link fw-bolder borrow"
                    href="javascript:void(0);"
                    id="transfer-coin-li"
                    onclick="changeRowDisplay(this);"
                    >Chuy·ªÉn xu v√†o Server</a
                  >
                </li>
                <li class="nav-item">
                  <a class="nav-link fw-bolder active" href="javascript:void(0);">L·ªãch s·ª≠ giao d·ªãch</a>
                </li>
              </ul>
            </div>
            <div
              class="col-10 pt-2 small position-relative"
              style="
                background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSVtergqy1I5RFXcG1--88_88HYHcS07MJhQf3awPzIq5uMYnmnCAFNssPlDhrAVdEBuSI&usqp=CAU');
              "
            >
              HISTORY
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<% } %>
<script>
  function letVerifyAccount() {
    swal({
      title: 'G·ª¨I X√ÅC TH·ª∞C T·ªöI EMAIL?',
      text: 'Ch√∫ng t√¥i s·∫Ω g·ª≠i m·ªôt ƒë∆∞·ªùng d·∫´n x√°c th·ª±c t√†i kho·∫£n t·ªõi email c·ªßa b·∫°n. M·ªôt khi t√†i kho·∫£n ƒë√£ x√°c th·ª±c th√¨ s·∫Ω kh√¥ng th·ªÉ thay ƒë·ªïi email m·ªõi v√† email ƒë√≥ s·∫Ω vƒ©nh vi·ªÖn l√† ch·ªß nh√¢n c·ªßa t√†i kho·∫£n n√†y. Kh√¥ng th·ªÉ ho√†n t√°c. B·∫°n ƒë√£ ch·∫Øc ch·∫Øn ch·ª©?',
      icon: 'warning',
      buttons: true,
      dangerMode: true,
    }).then((intend) => {
      if (intend) {
        // Ki·ªÉm tra email h∆°p l·ªá
        const email = $('#email').val()
        const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/
        if (!emailRegex.test(email)) {
          toastr.error('Email c·∫ßn x√°c minh sai ƒë·ªãnh d·∫°ng.', 'L·ªói!')
          $('#email').focus()
          $('#mySwitch').prop('checked', false)
          return false
        }
        const data = { email }
        $.ajax({
          url: '/profile/verify',
          method: 'POST',
          data: data,
          success: (sweetResponse) => {
            swal({
              title: sweetResponse.title,
              text: sweetResponse.text,
              icon: sweetResponse.icon,
            }).then(() => {
              $('#profileBox').modal('toggle')
            })
          },
          error(error) {
            swal({
              title: 'L·ªói',
              text: error.statusText,
              icon: 'error',
            })
            console.error('error=', error)
          },
        })
      }
      $('#mySwitch').prop('checked', false)
    })
  }

  function changeRowDisplay(obj) {
    const arrayRows = ['info-li', 'transfer-coin-li', 'history-li']
    for (let i = 0; i < arrayRows.length; i++) {
      const element = arrayRows[i]
      if (element !== obj.id) {
        const newElement = element.replace('li', 'row')
        const hideRow = $('#' + newElement)
        hideRow.removeClass('d-flex')
        hideRow.addClass('d-none')
      }
    }
    const newObj = obj.id.replace('li', 'row')
    const mainRow = $('#' + newObj)
    mainRow.removeClass('d-none')
    mainRow.addClass('d-flex')
  }

  function saveProfile() {
    window.showLoadingBox()
    const fullname = $('#fullname').val()
    const sdt = $('#sdt').val()
    const country = $('#country').val()
    const address = $('#address').val()
    const data = {
      fullname,
      sdt,
      country,
      address,
    }
    if (!fullname) {
      toastr.error('H·ªç v√† t√™n ch∆∞a h·ª£p l·ªá!', 'L·ªói')
      return
    }
    const phoneNumberRegex = /^(0[1-9])+([0-9]{8,9})\b/
    if (!phoneNumberRegex.test(sdt)) {
      toastr.error('S·ªë ƒëi·ªán tho·∫°i ch∆∞a h·ª£p l·ªá!', 'L·ªói')
      return
    }
    if (!address) {
      toastr.error('ƒê·ªãa ch·ªâ ch∆∞a h·ª£p l·ªá!', 'L·ªói')
      return
    }
    $.ajax({
      url: '/profile/update',
      method: 'PUT',
      data: data,
      success: function (sweetResponse) {
        if (sweetResponse.icon === 'success') {
          swal({
            title: sweetResponse.title,
            text: sweetResponse.text,
            icon: sweetResponse.icon,
          }).then(() => {
            $('#fullname').val(fullname)
            $('#sdt').val(sdt)
            $('#address').val(address)
          })
        }
      },
      error: function (e) {
        console.error('L·ªói:', e)
        toastr.error(e.message, 'L·ªói')
      },
      complete: function () {
        window.hideLoadingBox()
      },
    })
  }
</script>
