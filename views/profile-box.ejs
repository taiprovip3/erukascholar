<!-- The Modal -->
<% if(payload.userData) { %>
<style>
  #profileBox .modal-body {
    background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRn6K94GJRJhQSBE9QYCuZLuMTNi7fL8EllzSE1I3CVvC86mJLQDWUzgjGvWv9CalGIYqA&usqp=CAU');
    box-shadow:
      rgb(85, 91, 255) 0px 0px 0px 3px,
      rgb(31, 193, 27) 0px 0px 0px 6px,
      rgb(255, 217, 19) 0px 0px 0px 9px,
      rgb(255, 156, 85) 0px 0px 0px 12px,
      rgb(255, 85, 85) 0px 0px 0px 15px;
  }
</style>
<div class="modal fade" id="profileBox">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <!-- Modal body -->
      <div class="modal-body" style="max-height: 80vh; overflow: auto">
        <div class="text-end">
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="container">
          <div class="row d-flex justify-content-center" id="info-row">
            <div
              class="col-2 pt-2 border-end border-dark"
              style="
                background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRV3MnyeO5LAIsaQk_Dxc0dNb-FZQrE4CuU3lhZA9xaG94hQ5mhT_4pb8YFbQWpOoIZxD4&usqp=CAU');
              "
            >
              <ul class="nav nav-tabs flex-column">
                <li class="nav-item">
                  <a class="nav-link fw-bolder active" href="javascript:void(0);">Th√¥ng tin</a>
                </li>
                <li class="nav-item">
                  <a
                    class="nav-link fw-bolder borrow"
                    href="javascript:void(0);"
                    id="inventory-li"
                    onclick="changeRowDisplay(this);"
                    >T√∫i</a
                  >
                </li>
                <li class="nav-item">
                  <a
                    class="nav-link fw-bolder borrow"
                    href="javascript:void(0);"
                    id="transfer-coin-li"
                    onclick="changeRowDisplay(this);"
                    >Chuy·ªÉn xu v√†o Server</a
                  >
                </li>
                <li class="nav-item">
                  <a
                    class="nav-link fw-bolder borrow"
                    href="javascript:void(0);"
                    id="history-li"
                    onclick="changeRowDisplay(this);"
                    >L·ªãch s·ª≠ giao d·ªãch</a
                  >
                </li>
              </ul>
            </div>
            <div
              class="col-4 pt-2 small position-relative"
              style="
                background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSVtergqy1I5RFXcG1--88_88HYHcS07MJhQf3awPzIq5uMYnmnCAFNssPlDhrAVdEBuSI&usqp=CAU');
              "
            >
              <div class="mb-3 text-center">
                <div class="position-relative">
                  <img src="/profile/avatar" alt="avatar" width="100px" height="100px" id="avatar" />
                  <div class="position-absolute end-0 bottom-0 violet rounded-1">
                    <input
                      type="file"
                      id="avatarInput"
                      name="avatarInput"
                      accept="image/*"
                      required
                      class="invisible"
                      onchange="uploadAvatar();"
                    />
                    <label for="avatarInput" class="crs"><i class="fa-regular fa-images"></i></label>
                  </div>
                </div>
                <h5><%= payload.userData.username %></h5>
                <span class="d-block"
                  >ƒê√£ tham gia:
                  <span class="borrow fw-bold"><%= helper.calculateTimeAgo(payload.userData.createdAt) %></span></span
                >
                <!-- <div class="d-flex align-items-center">
                                <div class="progress flex-fill">
                                    <div class="progress-bar bg-success" style="width:99%"></div>
                                    99üåø
                                </div>
                                <div class="small">100üåø</div>
                            </div> -->
                <span
                  >Th√†nh vi√™n th·ª© <span class="text-primary">#<%= payload.userData.profileId %></span></span
                >
                <br />
                <br />
                <div class="form-check form-switch">
                  <% if(payload.userData.isVerified) { %>
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="mySwitch"
                    name="darkmode"
                    value="yes"
                    checked
                    onchange="this.checked = !this.checked"
                  />
                  ‚úÖ
                  <% } else { %>
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="mySwitch"
                    name="darkmode"
                    value="no"
                    onclick="letVerifyAccount();"
                  />
                  ‚≠ï
                  <% } %>
                  <label class="form-check-label" for="mySwitch">X√°c th·ª±c T√†i kho·∫£n</label>
                </div>
              </div>
              <div class="position-absolute bottom-0 w-100 text-center mb-3">
                <a class="btn btn-danger" type="button" href="/logout">ƒêƒÉng xu·∫•t</a>
              </div>
            </div>
            <div
              class="col-6 pt-2 small"
              style="
                background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSVtergqy1I5RFXcG1--88_88HYHcS07MJhQf3awPzIq5uMYnmnCAFNssPlDhrAVdEBuSI&usqp=CAU');
              "
            >
              <h5 class="borrow fw-bold">Th√¥ng tin</h5>
              <div class="d-flex flex-wrap justify-content-between">
                <div>
                  <div class="mb-3 mt-3">
                    <label for="fullname" class="form-label">H·ªç v√† t√™n</label>
                    <input
                      type="text"
                      class="form-control text-white"
                      id="fullname"
                      placeholder="Enter fullname"
                      value="<%=  payload.userData.fullname %>"
                      name="fullname"
                      style="background-color: #1a233a"
                    />
                  </div>
                </div>
                <div>
                  <div class="mb-3 mt-3">
                    <label for="email" class="form-label">Email</label>
                    <% if(payload.userData.isVerified) { %>
                    <input
                      type="email"
                      class="form-control text-white"
                      id="email"
                      placeholder="Enter email"
                      value="<%=  payload.userData.email %>"
                      name="email"
                      style="background-color: #1a233a"
                      readonly
                    />
                    <% } else { %>
                    <input
                      type="email"
                      class="form-control text-white"
                      id="email"
                      placeholder="Enter email"
                      value="<%=  payload.userData.email %>"
                      name="email"
                      style="background-color: #1a233a"
                    />
                    <% } %>
                  </div>
                </div>
                <div>
                  <div class="mb-3 mt-3">
                    <label for="sdt" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                    <select name="country" id="country">
                      <option value="+84">+84</option>
                    </select>
                    <input
                      type="text"
                      class="form-control text-white"
                      id="sdt"
                      placeholder="Enter sdt"
                      value="<%=  payload.userData.sdt %>"
                      name="sdt"
                      style="background-color: #1a233a"
                    />
                  </div>
                </div>
              </div>
              <h5 class="borrow fw-bold">ƒê·ªãa ch·ªâ</h5>
              <textarea
                class="form-control text-white"
                rows="5"
                id="address"
                name="address"
                style="background-color: #1a233a"
              >
<%=  payload.userData.address %></textarea
              >
              <div class="w-100 mt-3 mb-3 text-end">
                <button class="btn btn-primary w-25" onclick="saveProfile();">C·∫≠p nh·∫≠t</button>
              </div>
            </div>
          </div>




          <div class="row d-none justify-content-center" id="inventory-row">
            <div
              class="col-2 pt-2 border-end border-dark"
              style="
                background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRV3MnyeO5LAIsaQk_Dxc0dNb-FZQrE4CuU3lhZA9xaG94hQ5mhT_4pb8YFbQWpOoIZxD4&usqp=CAU');
              "
            >
              <ul class="nav nav-tabs flex-column">
                <li class="nav-item">
                  <a class="nav-link fw-bolder borrow" href="javascript:void(0);" id="info-li" onclick="changeRowDisplay(this);">Th√¥ng tin</a>
                </li>
                <li class="nav-item">
                  <a
                    class="nav-link fw-bolder borrow active"
                    href="javascript:void(0);"
                    id="inventory-li"
                    >T√∫i</a
                  >
                </li>
                <li class="nav-item">
                  <a
                    class="nav-link fw-bolder borrow"
                    href="javascript:void(0);"
                    id="transfer-coin-li"
                    onclick="changeRowDisplay(this);"
                    >Chuy·ªÉn xu v√†o Server</a
                  >
                </li>
                <li class="nav-item">
                  <a
                    class="nav-link fw-bolder borrow"
                    href="javascript:void(0);"
                    id="history-li"
                    onclick="changeRowDisplay(this);"
                    >L·ªãch s·ª≠ giao d·ªãch</a
                  >
                </li>
              </ul>
            </div>
            <div
              class="col-10 pt-2 small position-relative"
              style="
                background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSVtergqy1I5RFXcG1--88_88HYHcS07MJhQf3awPzIq5uMYnmnCAFNssPlDhrAVdEBuSI&usqp=CAU');
              "
            >
              <div class="d-flex flex-wrap" id="resources">
                <div class="col-2 resource p-1">
                  <div class="border border-dark text-center crs" data-bs-toggle="tooltip" title="Hooray!">
                    <img src="./images/folder-grass.png" alt="resource" width="64" height="64" />
                    <br>
                    <a href="" class="text-decoration-none small" target="_blank">File Skyblock 1.12.+ 2021 <i class="fas fa-external-link-square-alt"></i></a>
                  </div>
                </div>
              </div>
            </div>
          </div>





          <div class="row d-none justify-content-center" id="transfer-coin-row">
            <div
              class="col-2 pt-2 border-end border-dark"
              style="
                background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRV3MnyeO5LAIsaQk_Dxc0dNb-FZQrE4CuU3lhZA9xaG94hQ5mhT_4pb8YFbQWpOoIZxD4&usqp=CAU');
              "
            >
              <ul class="nav nav-tabs flex-column">
                <li class="nav-item">
                  <a
                    class="nav-link fw-bolder borrow"
                    href="javascript:void(0);"
                    id="info-li"
                    onclick="changeRowDisplay(this);"
                    >Th√¥ng tin</a
                  >
                </li>
                <li class="nav-item">
                  <a
                    class="nav-link fw-bolder borrow"
                    href="javascript:void(0);"
                    id="inventory-li"
                    onclick="changeRowDisplay(this);"
                    >T√∫i</a
                  >
                </li>
                <li class="nav-item">
                  <a class="nav-link fw-bolder active" href="javascript:void(0);">Chuy·ªÉn xu v√†o Server</a>
                </li>
                <li class="nav-item">
                  <a
                    class="nav-link fw-bolder borrow"
                    href="javascript:void(0);"
                    id="history-li"
                    onclick="changeRowDisplay(this);"
                    >L·ªãch s·ª≠ giao d·ªãch</a
                  >
                </li>
              </ul>
            </div>
            <div
              class="col-10 p-2 small position-relative"
              style="
                background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSVtergqy1I5RFXcG1--88_88HYHcS07MJhQf3awPzIq5uMYnmnCAFNssPlDhrAVdEBuSI&usqp=CAU');
              "
            >
              <div>
                S·ªë xu ƒëang c√≥:
                <%= payload.userData.balance %>
                ü•Æ
              </div>
              <div>
                <span>Chuy·ªÉn v√†o server:</span>
                <select name="serverSelection" id="serverSelection" onchange="onServerSelectionChange(this);">
                  <option value="">Vui l√≤ng ch·ªçn server chuy·ªÉn v√†o</option>
                </select>
              </div>
              <div class="">
                <span>S·ªë xu mu·ªën chuy·ªÉn:</span>
                <input
                  type="number"
                  name="inputCoin"
                  id="inputCoin"
                  maxlength="255"
                  value="<%= payload.userData.balance %>"
                />
              </div>
              <div class="border border-secondary p-2 my-2 text-center" id="playerServerStatsBox">
                <span class="d-block">Ch∆∞a t√¨m th·∫•y d·ªØ li·ªáu ü´ó</span>
                <img
                  src="https://i.pinimg.com/originals/a5/0c/98/a50c988565051c62e9315b8b591f877f.gif"
                  alt="not-found"
                  width="64"
                  height="64"
                />
              </div>
              <div class="text-end">
                <button class="btn btn-primary text-white fw-bolder" onclick="forwardCoins();">Chuy·ªÉn xu v√†o</button>
              </div>
            </div>
          </div>





          
          <div class="row d-none justify-content-center" id="history-row">
            <div
              class="col-2 pt-2 border-end border-dark"
              style="
                background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRV3MnyeO5LAIsaQk_Dxc0dNb-FZQrE4CuU3lhZA9xaG94hQ5mhT_4pb8YFbQWpOoIZxD4&usqp=CAU');
              "
            >
              <ul class="nav nav-tabs flex-column">
                <li class="nav-item">
                  <a
                    class="nav-link fw-bolder borrow"
                    href="javascript:void(0);"
                    id="info-li"
                    onclick="changeRowDisplay(this);"
                    >Th√¥ng tin</a
                  >
                </li>
                <li class="nav-item">
                  <a
                    class="nav-link fw-bolder borrow"
                    href="javascript:void(0);"
                    id="inventory-li"
                    onclick="changeRowDisplay(this);"
                    >T√∫i</a
                  >
                </li>
                <li class="nav-item">
                  <a
                    class="nav-link fw-bolder borrow"
                    href="javascript:void(0);"
                    id="transfer-coin-li"
                    onclick="changeRowDisplay(this);"
                    >Chuy·ªÉn xu v√†o Server</a
                  >
                </li>
                <li class="nav-item">
                  <a class="nav-link fw-bolder active" href="javascript:void(0);">L·ªãch s·ª≠ giao d·ªãch</a>
                </li>
              </ul>
            </div>
            <div
              class="col-10 p-3 small position-relative"
              style="
                background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSVtergqy1I5RFXcG1--88_88HYHcS07MJhQf3awPzIq5uMYnmnCAFNssPlDhrAVdEBuSI&usqp=CAU');
              "
            >
              <div class="table-responsive">
                <table border="1">
                  <thead
                    style="
                      background-image: url('https://lh3.googleusercontent.com/A9-BYyZa2yRTJRP3vrg7cG_UTqX9hGEUMEMLJOzhwFH3534nKOpUFLEX3qEn6-3v7HvEzKrQRWN_yPS0KOt6Pij-th3Hp1bmIA=s400');
                    "
                  >
                    <tr class="fw-bolder">
                      <td>#</td>
                      <td>M√£ giao d·ªãch</td>
                      <td>V·∫≠n h√†nh</td>
                      <td>S·ªë ti·ªÅn</td>
                      <td>V√†o l√∫c</td>
                      <td>L·ªùi nh·∫Øn</td>
                      <td>Tr·∫°ng th√°i</td>
                    </tr>
                  </thead>
                  <tbody
                    id="historyBody"
                    class="text-white"
                    style="
                      background-image: url('https://huggingface.co/TechieCrow/minecraft-log-textures/resolve/main/sample_images/minecraft_log_side_textures_(7).jpg');
                    "
                  ></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  initSkeleton()

  async function initSkeleton() {
    /*
      C√°c c√¥ng vi·ªác c·∫ßn load
      01 Load serverSelection [transfer-coin]
      02 Load historyUserTransaction [history]
      03 Load userInventory [inventory]
    */
    setInventory();
    setServerSelection()
    setHistories()
  }

  async function setInventory() {
    const resouces = await getInventory();
    const resourcesContainer = $("#resources");
    if(resouces.length <= 0) {
      const emptyResourceContent = `
        B·∫°n kh√¥ng c√≥ g√≥i t√†i nguy√™n n√†o c·∫£!
      `;
      resourcesContainer.html(emptyResourceContent);
      return;
    }
    let resourceContents = "";
    resouces.forEach(resource => {
      const formattedTime = moment(resource.created_at).format('YYYY-MM-DD HH:mm:ss')
      resourceContents += `
      <div class="col-2 resource p-1">
        <div class="border border-dark text-center crs" data-bs-toggle="tooltip" title="ƒê√£ mua v√†o l√∫c ${formattedTime}">
          <img src="./images/folder-grass.png" alt="resource" width="64" height="64" />
          <br>
          <a href="${resource.link}" class="text-decoration-none small" target="_blank">${resource.file_name}<i class="fas fa-external-link-square-alt"></i></a>
        </div>
      </div>
      `;
    });
    resourcesContainer.html(resourceContents);
  }

  async function getInventory() {
    return $.ajax({
      url: '/inventory',
      method: 'GET',
      contentType: 'application/json',
    }).then((data) => data)
  }

  async function setServerSelection() {
    const servers = await getServers()
    const selectBox = $('#serverSelection')
    $.each(servers, function (index, obj) {
      const optionText = obj.charAt(0).toUpperCase() + obj.slice(1)
      const option = $('<option>').text(optionText).val(obj)
      selectBox.append(option)
    })
  }

  function onServerSelectionChange(object) {
    const selectedIndex = object.selectedIndex
    const selectedValue = object.options[selectedIndex].value
    const playerServerStatsBox = $('#playerServerStatsBox')
    if (!selectedValue) {
      const notFoundContent = `
        <span class="d-block">Ch∆∞a t√¨m th·∫•y d·ªØ li·ªáu ü´ó</span>
        <img src="https://i.pinimg.com/originals/a5/0c/98/a50c988565051c62e9315b8b591f877f.gif" alt="not-found" width="64" height="64" />
      `
      playerServerStatsBox.html(notFoundContent)
      return
    }
    $.ajax({
      url: `/servers/getPlayerCoins?server=${selectedValue}`,
      method: 'GET',
      success: function (response) {
        /* expected result: {username:xxx, uuid:xxx, coins:xxx} */
        const userStatFoundContent = `
          <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTehc2GkyE0vk-HRcsYS_mxqm1RuGvtCwhXKZh8Qbdg63jTmbduhXJqqRw7pQxYJs3jtS8&usqp=CAU" alt="steve-head-icon" width="64" height="64" class="img-thumbnail" />
          <span class="d-block"><b>Username</b>: ${response.username}</span>
          <span class="d-block"><b>UUID</b>: ${response.uuid}</span>
          <span class="d-block"><b>Xu c√≥ s·∫µn</b>: ${response.coins} ü•Æ <span class="text-success"><i class="fa-solid fa-up-long"></i></span></span>
        `
        playerServerStatsBox.html(userStatFoundContent)
      },
      error: function (err) {
        console.error('error=', err)
        toastr.info('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu', 'Ch∆∞a tham gia m√°y ch·ªß n√†y')
        const notFoundContent = `
          <span class="d-block">Ch∆∞a t√¨m th·∫•y d·ªØ li·ªáu ü´ó</span>
          <img src="https://i.pinimg.com/originals/a5/0c/98/a50c988565051c62e9315b8b591f877f.gif" alt="not-found" width="64" height="64" />
        `
        const playerServerStatsBox = $('#playerServerStatsBox')
        playerServerStatsBox.html(notFoundContent)
      },
    })
  }

  async function getServers() {
    return $.ajax({
      url: '/servers',
      method: 'GET',
      contentType: 'application/json',
    }).then((data) => data)
  }

  async function setHistories() {
    const transactions = await getHistories()
    const tbody = $('#historyBody')
    if(transactions.length <= 0) {
      const row = `
        <tr><td colspan="7" class="text-center">Kh√¥ng c√≥ giao d·ªãch n√†o!</td></tr>
      `;
      tbody.append(row);
      return;
    }
    transactions.forEach(function (transaction, index) {
      const formattedTime = moment(transaction.created_at).format('YYYY-MM-DD HH:mm:ss')
      const formattedAmount = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(
        transaction.amount,
      )
      const row = `<tr>
        <td class="small">${index + 1}</td>
        <td class="small">${transaction.transId}</td>
        <td class="small">${transaction.bankCode}</td>
        <td class="small">${formattedAmount}</td>
        <td class="text-nowrap small">${formattedTime}</td>
        <td class="small">${transaction.message}</td>
        <td class="small">${transaction.status ? transaction.status : ' '}</td>
      </tr>`
      tbody.append(row)
    })
  }

  async function getHistories() {
    return $.ajax({
      url: '/history',
      type: 'GET',
      contentType: 'application/json',
    }).then((data) => data)
  }

  function letVerifyAccount() {
    swal({
      title: 'G·ª¨I X√ÅC TH·ª∞C T·ªöI EMAIL?',
      text: 'Ch√∫ng t√¥i s·∫Ω g·ª≠i m·ªôt ƒë∆∞·ªùng d·∫´n x√°c th·ª±c t√†i kho·∫£n t·ªõi email c·ªßa b·∫°n. M·ªôt khi t√†i kho·∫£n ƒë√£ x√°c th·ª±c th√¨ s·∫Ω kh√¥ng th·ªÉ thay ƒë·ªïi email m·ªõi v√† email ƒë√≥ s·∫Ω vƒ©nh vi·ªÖn l√† ch·ªß nh√¢n c·ªßa t√†i kho·∫£n n√†y. Kh√¥ng th·ªÉ ho√†n t√°c. B·∫°n ƒë√£ ch·∫Øc ch·∫Øn ch·ª©?',
      icon: 'warning',
      buttons: true,
      dangerMode: true,
    }).then((intend) => {
      if (intend) {
        // Ki·ªÉm tra email h∆°p l·ªá
        const email = $('#email').val()
        const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/
        if (!emailRegex.test(email)) {
          toastr.error('Email c·∫ßn x√°c minh sai ƒë·ªãnh d·∫°ng.', 'L·ªói!')
          $('#email').focus()
          $('#mySwitch').prop('checked', false)
          return false
        }
        const data = { email }
        $.ajax({
          url: '/profile/verify',
          method: 'POST',
          data: data,
          success: (sweetResponse) => {
            swal({
              title: sweetResponse.title,
              text: sweetResponse.text,
              icon: sweetResponse.icon,
            }).then(() => {
              $('#profileBox').modal('toggle')
            })
          },
          error(error) {
            swal({
              title: 'L·ªói',
              text: error.statusText,
              icon: 'error',
            })
            console.error('error=', error)
          },
        })
      }
      $('#mySwitch').prop('checked', false)
    })
  }

  function changeRowDisplay(obj) {
    const arrayRows = ['info-li', 'inventory-li', 'transfer-coin-li', 'history-li']
    for (let i = 0; i < arrayRows.length; i++) {
      const element = arrayRows[i]
      if (element !== obj.id) {
        const newElement = element.replace('li', 'row')
        const hideRow = $('#' + newElement)
        hideRow.removeClass('d-flex')
        hideRow.addClass('d-none')
      }
    }
    const newObj = obj.id.replace('li', 'row')
    const mainRow = $('#' + newObj)
    mainRow.removeClass('d-none')
    mainRow.addClass('d-flex')
  }

  function saveProfile() {
    window.showLoadingBox()
    const fullname = $('#fullname').val()
    const sdt = $('#sdt').val()
    const country = $('#country').val()
    const address = $('#address').val()
    const data = {
      fullname,
      sdt,
      country,
      address,
    }
    if (!fullname) {
      window.hideLoadingBox()
      toastr.error('H·ªç v√† t√™n ch∆∞a h·ª£p l·ªá!', 'L·ªói')
      return
    }
    const phoneNumberRegex = /^(0[1-9])+([0-9]{8,9})\b/
    if (!phoneNumberRegex.test(sdt)) {
      window.hideLoadingBox()
      toastr.error('S·ªë ƒëi·ªán tho·∫°i ch∆∞a h·ª£p l·ªá!', 'L·ªói')
      return
    }
    if (!address) {
      window.hideLoadingBox()
      toastr.error('ƒê·ªãa ch·ªâ ch∆∞a h·ª£p l·ªá!', 'L·ªói')
      return
    }
    $.ajax({
      url: '/profile/update',
      method: 'PUT',
      data: data,
      success: function (sweetResponse) {
        if (sweetResponse.icon === 'success') {
          swal({
            title: sweetResponse.title,
            text: sweetResponse.text,
            icon: sweetResponse.icon,
          }).then(() => {
            $('#fullname').val(fullname)
            $('#sdt').val(sdt)
            $('#address').val(address)
          })
        }
      },
      error: function (e) {
        console.error('L·ªói:', e)
        toastr.error(e.message, 'L·ªói')
      },
      complete: function () {
        window.hideLoadingBox()
      },
    })
  }

  function uploadAvatar() {
    const fileInput = document.getElementById('avatarInput')
    const file = fileInput.files[0]
    if (file) {
      if (file.size > 2 * 1024 * 1024) {
        swal({
          title: 'K√çCH TH∆Ø·ªöC ·∫¢NH QU√Å L·ªöN',
          text: 'T·∫≠p tin ƒë√£ v∆∞·ª£t qu√° 2MB. Vui l√≤ng ch·ªçn t·∫≠p tin k√≠ch th∆∞·ªõc nh·ªè h∆°n.',
          icon: 'warning',
        })
        return
      }
      var formData = new FormData()
      formData.append('avatar', file)
      $.ajax({
        url: '/profile/upload-avatar',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
          swal({
            title: 'T·∫¢I ·∫¢NH L√äN TH√ÄNH C√îNG',
            text: 'Avatar c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t sau √≠t ph√∫t n·ªØa. Ki√™n nh·∫´n ch·ªù ƒë·ª£i nh√©.',
            icon: 'success',
          }).then(() => {
            $('#avatar').attr('src', `/profile/avatar?randomRefresh=${Math.random()}`)
          })
        },
        error: function (error) {
          console.error(error)
          toastr.error('L·ªói', error.responseText)
        },
      })
    } else {
      alert('Please choose a file.')
    }
  }

  function forwardCoins() {
    const balanceToForward = $('#inputCoin').val()
    if (balanceToForward <= 0 || !Number(balanceToForward)) {
      toastr.error('S·ªë xu chuy·ªÉn ph·∫£i > 0', 'L·ªói')
      return
    }
    const selectedServerName = $('#serverSelection option:selected').val()
    if (!selectedServerName) {
      toastr.error('Vui l√≤ng m·ªôt ch·ªçn m√°y ch·ªß ƒë·ªÉ chuy·ªÉn xu v√†o', 'L·ªói')
      return
    }
    swal({
      title: 'B·∫°n ch·∫Øc ch·ª©',
      text: `S·∫Ω chuy·ªÉn ${balanceToForward} v√†o m√°y ch·ªß ${selectedServerName} ch·ª©. H√†nh ƒë·ªông ngu ng·ªëc n√†y s·∫Ω kh√¥ng th·ªÉ ho√†n t√°c, h√£y c√¢n nh·∫Øc k·ªπ!`,
      icon: 'warning',
      buttons: true,
      dangerMode: true,
    }).then((willDelete) => {
      if (willDelete) {
        $.ajax({
          url: '/servers/forwardCoins',
          method: 'POST',
          data: { balanceToForward, serverName: selectedServerName },
          success: function (sweetResponse) {
            swal({
              title: sweetResponse.title,
              text: sweetResponse.text,
              icon: sweetResponse.icon,
            }).then(() => {
              if (sweetResponse.icon === 'success') {
                window.location.href = window.location.href
              }
            })
          },
          error: function (err) {
            console.error('error=', err)
            toastr.error(err.responseText, 'L·ªói')
          },
        })
      }
    })
  }
</script>
<% } %>