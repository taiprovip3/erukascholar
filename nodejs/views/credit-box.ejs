<!-- The Modal -->
<% if(payload.userData) { %>
<style>
  #creditBox .modal-body {
    background-image: url('/images/dark-oak-bg.jpg');
    box-shadow:
      rgb(85, 91, 255) 0px 0px 0px 3px,
      rgb(31, 193, 27) 0px 0px 0px 6px,
      rgb(255, 217, 19) 0px 0px 0px 9px,
      rgb(255, 156, 85) 0px 0px 0px 12px,
      rgb(255, 85, 85) 0px 0px 0px 15px;
  }
</style>
<div class="modal fade" id="creditBox">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <!-- Modal body -->
      <div class="modal-body">
        <div class="text-end">
          <button type="button" class="btn-close bg-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="container">
          <div class="row">
            <div class="col-12 text-white">
              <p>
                <i class="fa-solid fa-skull-crossbones text-warning"></i> Vui l√≤ng l∆∞u √Ω m·ªôt v√†i ƒëi·ªÅu sau tr∆∞·ªõc khi n·∫°p
                th·∫ª:
              </p>
              <ol class="list-group list-group-numbered">
                <li class="list-group-item">
                  Sau khi n·∫°p th·∫ª th√†nh c√¥ng, xu s·∫Ω ƒë∆∞·ª£c c·ªông v√†o t√†i kho·∫£n website, ch∆∞a c·ªông xu v√†o trong game. C·∫ßn
                  th√™m 1 thao t√°c chuy·ªÉn xu (ü•Æ) v√†o server m·ªõi c√≥ xu trong game.
                </li>
                <li class="list-group-item">
                  ƒê·ªëi v·ªõi n·∫°p th·∫ª. Kh√¥ng ƒë∆∞·ª£c ph√©p ch·ªçn sai <b>M·ªÜNH GI√Å TH·∫∫</b> & <b>LO·∫†I TH·∫∫</b> ƒë·ªÉ tr√°nh b·ªã nu·ªët th·∫ª
                  (kh√¥ng th·ªÉ h·ªó tr·ª£).
                </li>
                <li class="list-group-item">
                  Khuy·∫øn kh√≠ch n·∫°p b·∫±ng [CHUY·ªÇN KHO·∫¢N CHAY] ho·∫∑c [IBANKING] ng√¢n h√†ng ho·∫∑c momo cho admin. Tuy ch·∫≠m m√† ch·∫Øc, an to√†n m√†
                  c√≤n kh√¥ng b·ªã chi·∫øt kh·∫•u.
                </li>
              </ol>
            </div>
          </div>
          <div class="row pt-2 mt-3">
            <div class="col-12 text-white">
              <ul class="mb-3 nav nav-tabs">
                <li class="nav-item" onclick="showCardForm();">
                  <a class="nav-link fw-bolder active" href="javascript:void(0);" id="tab-card">N·∫°p th·∫ª</a>
                </li>
                <li class="nav-item" onclick="showIBankingForm();">
                  <a class="nav-link fw-bolder" href="javascript:void(0);" id="tab-ibanking">Internet Banking</a>
                </li>
                <li class="nav-item" onclick="showBankTransferForm();">
                  <a class="nav-link fw-bolder" href="javascript:void(0);" id="tab-bank-transfer">Chuy·ªÉn kho·∫£n</a>
                </li>
              </ul>
              <form method="post" id="card-form">
                <div class="mb-3">
                  <label for="credit_box_email">T√†i kho·∫£n</label>
                  <input
                    type="text"
                    name="credit_box_email"
                    id="credit_box_email"
                    class="form-control bg-dark text-white"
                    value="<%= payload.userData.email %>"
                    required
                    readonly
                  />
                </div>
                <div class="mb-3">
                  <label for="credit_box_provider">Nh√† m·∫°ng</label>
                  <select
                    name="credit_box_provider"
                    id="credit_box_provider"
                    class="form-select bg-dark text-white"
                    onchange="onProviderChange(this);"
                  ></select>
                </div>
                <div class="mb-3">
                  <label for="credit_box_value"
                    >M·ªánh gi√°
                    <span
                      class="crs"
                      data-bs-toggle="tooltip"
                      title="N√™n n·∫°p b·∫±ng chuy·ªÉn kho·∫£n cho Admin tuy l√¢u nh∆∞ng s·∫Ω nh·∫≠n 100% gi√° tr·ªã. Nh·∫Øn tin facebook cho admin ngay khi chuy·ªÉn kho·∫£n."
                      >üí°</span
                    ></label
                  >
                  <select name="credit_box_value" id="credit_box_value" class="form-select bg-dark text-white"></select>
                </div>
                <div class="mb-3">
                  <label for="credit_box_seri">S·ªë seri</label>
                  <input
                    type="text"
                    name="credit_box_seri"
                    id="credit_box_seri"
                    class="form-control bg-dark text-white"
                    placeholder="Nh·∫≠p s·ªë seri..."
                    required
                  />
                </div>
                <div class="mb-3">
                  <label for="credit_box_pin">M√£ th·∫ª</label>
                  <input
                    type="text"
                    name="credit_box_pin"
                    id="credit_box_pin"
                    class="form-control bg-dark text-white"
                    placeholder="Nh·∫≠p m√£ th·∫ª..."
                    required
                  />
                </div>
                <div class="mb-3 text-end">
                  <button class="btn btn-primary fw-bold" type="submit">N·∫°p th·∫ª</button>
                </div>
              </form>
              <style>
                #bank-transfer-form,
                #ibanking-form {
                  display: none;
                }
              </style>
              <form id="ibanking-form">
                <div class="mb-3">
                  <label for="ibanking_value">S·ªë ti·ªÅn mu·ªën n·∫°p</label>
                  <input
                    type="number"
                    name="ibanking_value"
                    id="ibanking_value"
                    class="form-control bg-dark text-white"
                    placeholder="Nh·∫≠p s·ªë ti·ªÅn.."
                    max="3000000"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label for="ibanking_bankcode">Ch·ªçn ng√¢n h√†ng</label>
                  <select name="ibanking_bankcode" id="ibanking_bankcode" class="form-select bg-dark text-white">
                    <option value="MOMO">Momo</option>
                    <option value="VCB">Ng√¢n h√†ng VCB</option>
                    <option value="BIDV">Ng√¢n h√†ng BIDV</option>
                  </select>
                </div>
                <div class="mb-3 text-end">
                  <button class="btn btn-warning fw-bold" type="submit">N·∫°p ngay</button>
                </div>
              </form>
              <div id="bank-transfer-form">
                <span class="d-block"
                  >ƒê·ªÉ n·∫°p xu v√†o t√†i kho·∫£n b·∫±ng c√°ch chuy·ªÉn kho·∫£n ng√¢n h√†ng ho·∫∑c momo cho Admin. Chuy·ªÉn ti·ªÅn ƒë·∫øn th√¥ng
                  tin t√†i kho·∫£n sau:</span
                >
                <ul>
                  <li>STK Ng√¢n h√†ng</li>
                  <li>0338188506</li>
                  <li>PHAN TAN TAI</li>
                  <li>MB Bank (Ng√¢n h√†ng TMCP Qu√¢n ƒê·ªôi Vi·ªát Nam)</li>
                  <li>Ho·∫∑c qu√©t m√£ QR sau:</li>
                  <li>
                    <img
                      src="/images/qr-mbbank.jpg"
                      alt="qr-code"
                      class="img-fluid"
                      width="256"
                    />
                  </li>
                  <li>N·ªôi dung chuy·ªÉn kho·∫£n:</li>
                  <li class="fst-italic">[Ghi email t√†i kho·∫£n website c·ªßa b·∫°n]</li>
                </ul>
                <ul>
                  <li>STK V√≠ Momo</li>
                  <li>0338188506</li>
                  <li>Phan T·∫•n T√†i</li>
                  <li>Ho·∫∑c qu√©t m√£ QR sau:</li>
                  <li>
                    <img
                      src="/images/qr-momo.jpg"
                      alt="qr-code"
                      class="img-fluid"
                      width="256"
                    />
                  </li>
                  <li>N·ªôi dung chuy·ªÉn kho·∫£n:</li>
                  <li class="fst-italic">[Ghi email t√†i kho·∫£n website c·ªßa b·∫°n]</li>
                </ul>
                <br />
                <span class="d-block text-danger"
                  ><i class="fa-solid fa-exclamation"></i> L∆∞u √Ω: Admin ch·ªâ d√πng 2 s·ªë t√†i kho·∫£n duy nh·∫•t b√™n d∆∞·ªõi, c√°c
                  s√≥ kh√°c ho·∫∑c t√™n kh√°c ƒë·ªÅu l√† l·ª´a ƒë·∫£o! H√£y c·∫©n th·∫≠n</span
                >
                <span class="text-info"
                  >Sau kho·∫£n ~ 2-4h (C√≥ th·ªÉ l√¢u h∆°n). CƒÉn c·ª© v√†o email, xu s·∫Ω ƒë∆∞·ª£c th√™m v√†o t√†i kho·∫£n c·ªß b·∫°n.</span
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="qrBox">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <!-- Modal body -->
      <div class="modal-body" style="background-color: #1a233a">
        <div class="text-end">
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="container">
          <div class="row" style="background-color: #272e48">
            <div class="col-12 text-white text-center" id="qrContent"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<% } %>
<script>
  let listTstProviderPopup = []
  initSkeleton()

  async function initSkeleton() {
    listTstProviderPopup = await getTSTProviders()
    setCardProviders()
    setCardValues()
  }

  async function getTSTProviders() {
    return $.ajax({
      url: '/tst/get-providers',
      method: 'GET',
      contentType: 'application/json',
    }).then((data) => data)
  }

  function setCardProviders() {
    const selectBox = $('#credit_box_provider')
    $.each(listTstProviderPopup, function (index, obj) {
      const option = $('<option>').text(obj.card_type).val(obj.card_type)
      selectBox.append(option)
    })
  }

  function setCardValues(provider) {
    if (!provider) {
      provider = listTstProviderPopup[0].card_type // L·∫•y ra lo·∫°i th·∫ª ƒë·∫ßu ti√™n
    }
    const foundProvider = listTstProviderPopup.find(function (obj) {
      return obj.card_type === provider
    })
    const selectBox = $('#credit_box_value')
    selectBox.empty()
    const discountObject = foundProvider.discount
    for (const key in discountObject) {
      const priceKey = Number(key)
      const lossDiscount = Number(discountObject[key])
      const willEarn = priceKey - priceKey * (lossDiscount / 100)
      const optionTextDisplay = `${key} ƒë (${willEarn / 100} ü•Æ) -> B·ªã chi·∫øt kh·∫•u ${lossDiscount}%`
      const option = $('<option>').text(optionTextDisplay).val(priceKey)
      selectBox.append(option)
    }
  }

  $('#ibanking-form').on('submit', (e) => {
    e.preventDefault()
    let formDataObject = {}
    const inputArray = $('#ibanking-form').serializeArray()
    $.each(inputArray, function (i, field) {
      formDataObject[field.name] = field.value
    })
    $.ajax({
      url: '/gb/ibanking/create-payment',
      method: 'POST',
      data: formDataObject,
      success: function (response) {
        // X·ª≠ l√Ω k·∫øt qu·∫£ th√†nh c√¥ng t·ª´ API
        $('#creditBox').modal('toggle')
        if (response.code == 1) {
          const htmlContent = `
            <div class="text-danger">‚ùó Vui l√≤ng kh√¥ng t·∫Øt h·ªôp tho·∫°i n√†y khi ch∆∞a l√†m xong thao t√°c. H·ªôp tho·∫°i s·∫Ω t·ª± ƒë√≥ng khi giao d·ªãch ho√†n t·∫•t.</div>
            <div class="my-1"><img src="${response.redirectLink}" alt="qrcode"></div>
            <div>${response.bank}</div>
            <div>${response.bankname}</div>
            <div>${response.phonenumber}</div>
            <div>N·ªôi dung chuy·ªÉn kho·∫£n: ${response.content}</div>
          `
          $('#qrContent').html(htmlContent)
          $('#qrBox').modal('toggle')
        } else {
          toastr.error(`Giao d·ªãch t·ªõi Third Party ƒë√£ b·ªã t·ª´ l·ªói. M√£ l·ªói: ${response.code}`, 'L·ªói')
        }
      },
      error: function (error) {
        // X·ª≠ l√Ω l·ªói t·ª´ API
        console.error('Error:', error)
      },
    })
  })
  $('#card-form').on('submit', (e) => {
    e.preventDefault()
    toastr.info('ƒêang ti·∫øn h√†nh n·∫°p th·∫ª', 'Vui l√≤ng ch·ªù')
    let formDataObject = {}
    const inputArray = $('#card-form').serializeArray()
    $.each(inputArray, function (i, field) {
      formDataObject[field.name] = field.value
    })
    $.ajax({
      url: '/tst/recharge',
      method: 'POST',
      data: formDataObject,
      success: (sweetResponse) => {
        swal({
          title: sweetResponse.title,
          text: sweetResponse.text,
          icon: sweetResponse.icon,
        })
      },
      error: (error) => {
        console.error('error=', error)
        toastr.error(`${error.responseText}`, 'L·ªói')
      },
    })
  })
  function onProviderChange(obj) {
    const provider = obj.value
    setCardValues(provider)
  }
  function showCardForm() {
    $('#tab-bank-transfer').removeClass('active')
    $('#tab-ibanking').removeClass('active')
    $('#tab-card').addClass('active')

    $('#bank-transfer-form').hide()
    $('#ibanking-form').hide()
    $('#card-form').show()
  }
  function showBankTransferForm() {
    $('#tab-card').removeClass('active')
    $('#tab-ibanking').removeClass('active')
    $('#tab-bank-transfer').addClass('active')

    $('#card-form').hide()
    $('#ibanking-form').hide()
    $('#bank-transfer-form').show()
  }
  function showIBankingForm() {
    $('#tab-card').removeClass('active')
    $('#tab-bank-transfer').removeClass('active')
    $('#tab-ibanking').addClass('active')

    $('#card-form').hide()
    $('#bank-transfer-form').hide()
    $('#ibanking-form').show()
  }
  function renderVNPBankList(banks) {
    const selectBank = $('#ibanking_bankcode')
    selectBank.empty()
    selectBank.append('<option value="" selected>Kh√¥ng ch·ªçn</option>')
    banks.forEach(function (bank) {
      selectBank.append('<option value="' + bank.bank_code + '">' + bank.bank_name + '</option>')
    })
  }
</script>
